#!/usr/bin/env bash
# C3: Full Validation — pre-push hook for the deploy repo
# Runs TypeScript compilation, CDK synth, CDK diff, and custom CDK lint
# before allowing pushes to main.
#
# Install: .githooks/setup.sh
# See: DDR-055-deployment-automation.md (in app repo docs/design-decisions/)
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info()  { echo -e "${GREEN}[pre-push]${NC} $*"; }
warn()  { echo -e "${YELLOW}[pre-push]${NC} $*"; }
error() { echo -e "${RED}[pre-push]${NC} $*"; }

# Only validate pushes to main branch
REMOTE="$1"
URL="$2"

PUSHING_TO_MAIN=false
while read -r local_ref local_oid remote_ref remote_oid; do
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    PUSHING_TO_MAIN=true
    break
  fi
done

if [ "$PUSHING_TO_MAIN" = "false" ]; then
  info "Not pushing to main — skipping validation"
  exit 0
fi

info "Pushing to main — running full validation (C3)"
echo ""

CDK_DIR="cdk"
FAILED=0

# Ensure we're in the repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Check for node_modules
if [ ! -d "$CDK_DIR/node_modules" ]; then
  warn "node_modules not found, running npm ci..."
  (cd "$CDK_DIR" && npm ci --silent 2>&1)
fi

# --- 1. TypeScript strict compilation ---
info "Running tsc --noEmit..."
if (cd "$CDK_DIR" && npx tsc --noEmit 2>&1); then
  info "TypeScript compilation: PASSED"
else
  error "TypeScript compilation: FAILED"
  FAILED=1
fi
echo ""

# --- 2. CDK Synth ---
info "Running cdk synth..."
if (cd "$CDK_DIR" && npx cdk synth --all --quiet 2>&1); then
  info "CDK synth: PASSED"
else
  error "CDK synth: FAILED"
  FAILED=1
fi
echo ""

# --- 3. CDK Diff ---
info "Running cdk diff (informational)..."
(cd "$CDK_DIR" && npx cdk diff --all 2>&1) || true
echo ""

# --- 4. Custom CDK lint (validate-cdk.sh) ---
VALIDATE_SCRIPT="$CDK_DIR/scripts/validate-cdk.sh"
if [ -f "$VALIDATE_SCRIPT" ]; then
  info "Running CDK validation script..."
  if bash "$VALIDATE_SCRIPT" 2>&1; then
    info "CDK validation: PASSED"
  else
    error "CDK validation: FAILED"
    FAILED=1
  fi
else
  warn "CDK validation script not found at $VALIDATE_SCRIPT — skipping"
fi
echo ""

# --- 5. Secret detection ---
info "Scanning for secrets..."
SECRET_PATTERNS=(
  'AKIA[0-9A-Z]{16}'            # AWS Access Key ID
  'aws_secret_access_key\s*='   # AWS Secret Key assignment
  'AIza[0-9A-Za-z_-]{35}'       # Google API Key
)

SECRETS_FOUND=false
PUSH_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

for pattern in "${SECRET_PATTERNS[@]}"; do
  if echo "$PUSH_FILES" | xargs grep -lEn "$pattern" 2>/dev/null | grep -v -E '\.(md|txt|sample)$'; then
    error "Potential secret found matching pattern: $pattern"
    SECRETS_FOUND=true
  fi
done

if [ "$SECRETS_FOUND" = "true" ]; then
  error "Secret detection: FAILED"
  FAILED=1
else
  info "Secret detection: PASSED"
fi
echo ""

# --- Summary ---
if [ "$FAILED" -ne 0 ]; then
  echo ""
  error "=== PRE-PUSH VALIDATION FAILED ==="
  error "Fix the issues above before pushing to main."
  error "To bypass (emergency only): git push --no-verify"
  exit 1
fi

info "=== ALL VALIDATIONS PASSED ==="
exit 0
